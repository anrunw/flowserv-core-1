swagger: "2.0"
info:
  description: "API specification for the Web server of the Reproducible and Reusable Data Analysis Workflow Server."
  version: "0.1.0"
  title: "Reproducible and Reusable Data Analysis Workflow Server (flowServ)"
  contact:
    email: "heiko.muller@gmail.com"
  license:
    name: "MIT"
    url: "https://opensource.org/licenses/MIT"
host: "localhost:5000"
basePath: "/flowserv/api/v1"
tags:
- name: "service"
  description: "Service description"
- name: "workflow"
  description: "Workflow templates"
- name: "groups"
  description: "Workflow user groups"
- name: "run"
  description: "Workflow runs"
- name: "file"
  description: "Uploaded files for workflow groups"
- name: "user"
  description: "Authenticate and register users"
schemes:
- "http"
paths:
# -----------------------------------------------------------------------------
# API Routes
# -----------------------------------------------------------------------------
# -- Service ------------------------------------------------------------------
  /:
    get:
      tags:
      - "service"
      summary: "Service descriptor"
      description: "Get service descriptor"
      operationId: "serviceDescriptor"
      produces:
      - "application/json"
      responses:
        200:
          description: "Service descriptor"
          schema:
            $ref: "#/definitions/ServiceDescriptor"
# -- Workflows ----------------------------------------------------------------
  /workflows:
    get:
      tags:
      - "workflow"
      summary: "List workflows"
      description: "Get listing of all current workflows"
      operationId: "listWorkflows"
      produces:
      - "application/json"
      responses:
        200:
          description: "Listing of workflow descriptors"
          schema:
            $ref: "#/definitions/WorkflowListing"
  /workflows/{workflowId}:
    get:
      tags:
      - "workflow"
      summary: "Get workflow handle"
      description: "Get handle for the given workflow"
      operationId: "getWorkflow"
      produces:
      - "application/json"
      parameters:
      - in: "path"
        name: "workflowId"
        description: "Unique workflow identifier"
        required: true
        type: string
      responses:
        200:
          description: "Workflow handle"
          schema:
            $ref: "#/definitions/WorkflowHandle"
        404:
          description: "Unknown workflow"
  /workflows/{workflowId}/leaderboard:
    get:
      tags:
      - "workflow"
      summary: "Get workflow leader board"
      description: "Get full leader board for the given workflow"
      operationId: "workflowLeaderboard"
      produces:
      - "application/json"
      parameters:
      - in: "path"
        name: "workflowId"
        description: "Unique workflow identifier"
        required: true
        type: string
      - in: "query"
        name: "orderBy"
        description: "List of result column names to order by (can include optional sort order). FOrmat is columnName[:ASC|DESC],"
        required: false
        type: string
      - in: "query"
        name: "includeAll"
        description: "Include all results (if true) or only one per user group (if false)"
        required: false
        type: boolean
      responses:
        200:
          description: "Workflow leaderboard"
          schema:
            $ref: "#/definitions/WorkflowLeaderboard"
        400:
          description: "Invalid sort statement"
        404:
          description: "Unknown workflow"
# -- User Groups --------------------------------------------------------------
  /workflows/{workflowId}/groups:
    get:
      tags:
      - "groups"
      summary: "List user groups for workflow"
      description: "Get a list of all user groups for a given workflow"
      operationId: "listUserGroups"
      produces:
      - "application/json"
      parameters:
      - in: "path"
        name: "workflowId"
        description: "Unique workflow identifier"
        required: true
        type: string
      responses:
        200:
          description: "User Group listing"
          schema:
            $ref: "#/definitions/UserGroupListing"
        403:
          description: "Forbidden operation"
      security:
        - api_key: []
    post:
      tags:
      - "groups"
      summary: "Create user group"
      description: "Create a new user group for a workflow"
      operationId: "createUserGroup"
      produces:
      - "application/json"
      parameters:
      - in: "path"
        name: "workflowId"
        description: "Unique workflow identifier"
        required: true
        type: string
      - name: body
        in: body
        required: true
        description: "User Group name and members"
        schema:
            type: object
            required:
            - name
            properties:
              name:
                type: string
              members:
                type: array
                items:
                  type: string
              parameters:
                type: array
                items:
                  $ref: '#/definitions/WorkflowParameter'
      responses:
        201:
          description: "User Group handle"
          schema:
            $ref: "#/definitions/UserGroupHandle"
        400:
          description: "Invalid user group statement"
        403:
          description: "Forbidden operation"
        404:
          description: "Unknown workflow"
      security:
        - api_key: []
  /groups:
    get:
      tags:
      - "groups"
      summary: "List user groups"
      description: "List all groups that a user is a member of"
      operationId: "listUserUserGroups"
      produces:
      - "application/json"
      responses:
        200:
          description: "User Group listing"
          schema:
            $ref: "#/definitions/UserGroupListing"
        403:
          description: "Forbidden operation"
      security:
        - api_key: []
  /groups/{userGroupId}:
    delete:
      tags:
      - "groups"
      summary: "Delete user group"
      description: "Delete a user group"
      operationId: "deleteUserGroup"
      produces:
      - "application/json"
      parameters:
      - in: "path"
        name: "userGroupId"
        description: "Unique user group identifier"
        required: true
        type: string
      responses:
        204:
          description: "UserGroup deleted"
        403:
          description: "Forbidden operation"
        404:
          description: "Unknown user group"
      security:
        - api_key: []
    get:
      tags:
      - "groups"
      summary: "Get user group handle"
      description: "Get handle for the given user group"
      operationId: "getUserGroup"
      produces:
      - "application/json"
      parameters:
      - in: "path"
        name: "userGroupId"
        description: "Unique user group identifier"
        required: true
        type: string
      responses:
        200:
          description: "User Group handle"
          schema:
            $ref: "#/definitions/UserGroupHandle"
        404:
          description: "Unknown user group"
      security:
        - api_key: []
    put:
      tags:
      - "groups"
      summary: "Update user group"
      description: "Update user group name and member list"
      operationId: "updateUserGroup"
      produces:
      - "application/json"
      parameters:
      - in: "path"
        name: "userGroupId"
        description: "Unique user group identifier"
        required: true
        type: string
      - name: body
        in: body
        required: true
        description: "User Group name and members"
        schema:
            type: object
            properties:
              name:
                type: string
              members:
                type: array
                items:
                  type: string
      responses:
        200:
          description: "Updated user group handle"
          schema:
            $ref: "#/definitions/UserGroupHandle"
        400:
          description: "Invalid user group statement"
        403:
          description: "Forbidden operation"
        404:
          description: "Unknown user group/user"
      security:
        - api_key: []
# -- Runs ---------------------------------------------------------------------
  /groups/{userGroupId}/runs:
    get:
      tags:
      - "run"
      summary: "List user group runs"
      description: "Get listing of all runs for the given user group"
      operationId: "listUserGroupRuns"
      produces:
      - "application/json"
      parameters:
      - in: "path"
        name: "userGroupId"
        description: "Unique user group identifier"
        required: true
        type: string
      responses:
        200:
          description: "Run listing"
          schema:
            $ref: "#/definitions/RunListing"
        403:
          description: "Forbidden operation"
        404:
          description: "Unknown user group"
      security:
        - api_key: []
    post:
      tags:
      - "run"
      summary: "Run workflow"
      description: "Submit arguments for a new workflow run"
      operationId: "runWorkflow"
      produces:
      - "application/json"
      parameters:
      - in: "path"
        name: "userGroupId"
        description: "Unique user group identifier"
        required: true
        type: string
      - name: body
        in: body
        required: true
        description: Run arguments
        schema:
          type: object
          required:
          - arguments
          properties:
            arguments:
              type: array
              items:
                $ref: '#/definitions/RunArgument'
      responses:
        201:
          description: "Run state"
          schema:
            $ref: "#/definitions/RunHandle"
        400:
          description: "Invalid argument list"
        403:
          description: "Forbidden operation"
        404:
          description: "Unknown user group"
      security:
        - api_key: []
  /runs/{runId}:
    delete:
      tags:
      - "run"
      summary: "Delete run"
      description: "Delete an inactive run"
      operationId: "deleteRun"
      produces:
      - "application/json"
      parameters:
      - in: "path"
        name: "runId"
        description: "Unique run identifier"
        required: true
        type: string
      responses:
        204:
          description: "Run deleted"
        400:
          description: "Invalid request for run state"
        403:
          description: "Forbidden operation"
        404:
          description: "Unknown run"
      security:
        - api_key: []
    get:
      tags:
      - "run"
      summary: "Get run"
      description: "Get state and timestamps for a given run"
      operationId: "getRun"
      produces:
      - "application/json"
      parameters:
      - in: "path"
        name: "runId"
        description: "Unique run identifier"
        required: true
        type: string
      responses:
        200:
          description: "Run handle"
          schema:
            $ref: "#/definitions/RunHandle"
        403:
          description: "Forbidden operation"
        404:
          description: "Unknown run"
      security:
        - api_key: []
    put:
      tags:
      - "run"
      summary: "Cancel run"
      description: "Cancel execution of an active run"
      operationId: "cancelRun"
      produces:
      - "application/json"
      parameters:
      - in: "path"
        name: "runId"
        description: "Unique run identifier"
        required: true
        type: string
      - name: body
        in: body
        required: true
        description: Run arguments
        schema:
          type: object
          properties:
            reason:
              type: string
      responses:
        200:
          description: "Run handle"
          schema:
            $ref: "#/definitions/RunHandle"
        400:
          description: "Invalid request for run state"
        403:
          description: "Forbidden operation"
        404:
          description: "Unknown run"
      security:
        - api_key: []
  /runs/{runId}/downloads/archive:
    get:
      tags:
      - "run"
      summary: "Download result file archive"
      description: "Download a tar archive containing all result files generated by a workflow run"
      operationId: "downloadRunResultArchive"
      produces:
      - "application/gzip"
      parameters:
      - in: "path"
        name: "runId"
        description: "Unique run identifier"
        required: true
        type: string
      responses:
        200:
          description: "File"
        403:
          description: "Forbidden operation"
        404:
          description: "Unknown run"
      security:
        - api_key: []
  /runs/{runId}/downloads/resources/{resourceId}:
    get:
      tags:
      - "run"
      summary: "Download result file"
      description: "Download a result file from a successful workflow run"
      operationId: "downloadResultFile"
      produces:
      - "text/csv"
      - "application/gzip"
      parameters:
      - in: "path"
        name: "runId"
        description: "Unique run identifier"
        required: true
        type: string
      - in: "path"
        name: "resourceId"
        description: "Unique resource identifier"
        required: true
        type: string
      responses:
        200:
          description: "File"
        403:
          description: "Forbidden operation"
        404:
          description: "Unknown run or resource"
      security:
        - api_key: []
# -- Files --------------------------------------------------------------------
  /uploads/{userGroupId}:
    get:
      tags:
      - "file"
      summary: "List files"
      description: "List all files that have been uploaded for a user group"
      operationId: "listFiles"
      produces:
      - "application/json"
      parameters:
      - in: "path"
        name: "userGroupId"
        description: "Unique user group identifier"
        required: true
        type: string
      responses:
        200:
          description: "List of uploaded files"
          schema:
            $ref: "#/definitions/FileListing"
        403:
          description: "Forbidden operation"
        404:
          description: "Unknown user group"
      security:
        - api_key: []
    post:
      tags:
      - "file"
      summary: "Upload file"
      description: "Upload a file to be available for future runs"
      operationId: "uploadFile"
      consumes:
      - "multipart/form-data"
      produces:
      - "application/json"
      parameters:
      - in: "path"
        name: "userGroupId"
        description: "Unique user group identifier"
        required: true
        type: string
      - in: "formData"
        name: "file"
        description: "Uploaded file"
        required: true
        type: file
      - in: "formData"
        name: "file_type"
        description: "File mimetype"
        required: false
        type: "string"
      responses:
        201:
          description: "Handle for uploaded file"
          schema:
            $ref: "#/definitions/FileHandle"
        403:
          description: "Forbidden operation"
        404:
          description: "Unknown user group"
        413:
            description: "Uploaded file size exceeds limit"
      security:
        - api_key: []
  /uploads/{userGroupId}/files/{fileId}:
    delete:
      tags:
      - "file"
      summary: "Delete file"
      description: "Delete a previously uploaded file"
      operationId: "deleteFile"
      produces:
      - "application/json"
      parameters:
      - in: "path"
        name: "userGroupId"
        description: "Unique user group identifier"
        required: true
        type: string
      - in: "path"
        name: "fileId"
        description: "Unique file identifier"
        required: true
        type: string
      responses:
        204:
          description: "List of uploaded files"
        403:
          description: "Forbidden operation"
        404:
          description: "Unknown user group or file"
      security:
        - api_key: []
    get:
      tags:
      - "file"
      summary: "Download file"
      description: "Download a previously uploaded file"
      operationId: "downloadFile"
      produces:
      - "text/csv"
      - "application/gzip"
      parameters:
      - in: "path"
        name: "userGroupId"
        description: "Unique user group identifier"
        required: true
        type: string
      - in: "path"
        name: "fileId"
        description: "Unique file identifier"
        required: true
        type: string
      responses:
        200:
          description: "File"
        403:
          description: "Forbidden operation"
        404:
          description: "Unknown user group or file"
      security:
        - api_key: []
# -- Users --------------------------------------------------------------------
  /users:
    get:
      tags:
      - "user"
      summary: "List users"
      description: "Query listing of registered users"
      operationId: "listUsers"
      produces:
      - "application/json"
      parameters:
      - in: "query"
        name: "query"
        description: "User name"
        required: false
        type: string
      responses:
        200:
          description: "Query result"
          schema:
            $ref: "#/definitions/UserListing"
        403:
          description: "Forbidden operation"
      security:
        - api_key: []
  /users/activate:
    post:
      tags:
      - "user"
      summary: "Activate a new user"
      description: "Activate a newly registered user"
      operationId: "activateUser"
      produces:
      - "application/json"
      parameters:
      - in: "body"
        name: "body"
        description: "Identifier for a registered user"
        required: true
        schema:
          type: object
          description: "Unique user identifier"
          required:
          - id
          properties:
            id:
              type: string
      responses:
        200:
          description: "User activated successfully"
          schema:
            $ref: "#/definitions/UserHandle"
        404:
          description: "Unknown user"
  /users/login:
    post:
      tags:
      - "user"
      summary: "User login"
      description: "Logs user into the system"
      operationId: "loginUser"
      produces:
      - "application/json"
      parameters:
      - in: "body"
        name: "body"
        description: "User name and password"
        required: true
        schema:
          $ref: "#/definitions/UserCredentials"
      responses:
        200:
          description: "User logged in successfully"
          schema:
            $ref: "#/definitions/UserHandle"
        400:
          description: "Invalid username/password supplied"
        404:
          description: "Unknown user"
  /users/logout:
    post:
      tags:
      - "user"
      summary: "Logout user"
      description: "Logs current user out"
      operationId: "logoutUser"
      produces:
      - "application/json"
      responses:
        200:
          description: "User logged out successfully"
          schema:
            $ref: "#/definitions/UserHandle"
        403:
          description: "Forbidden operation"
      security:
        - api_key: []
  /users/password/request:
    post:
      tags:
      - "user"
      summary: "Request password reset"
      description: "Get unique request identifier to reset user password"
      operationId: "requestPasswordReset"
      produces:
      - "application/json"
      parameters:
      - in: "body"
        name: "body"
        description: "User name"
        required: true
        schema:
          type: object
          required:
          - username
          properties:
            username:
              type: string
      responses:
        200:
          description: "User activated successfully"
          schema:
            type: object
            required:
            - requestId
            properties:
              requestId:
                type: string
  /users/password/reset:
    post:
      tags:
      - "user"
      summary: "Reset password"
      description: "Reset the password for a user following a password reset request"
      operationId: "resetPassword"
      produces:
      - "application/json"
      parameters:
      - in: "body"
        name: "body"
        description: "Reset request identifier and new password"
        required: true
        schema:
          type: object
          required:
          - requestId
          - password
          properties:
            requestId:
              type: string
            password:
              type: string
      responses:
        200:
          description: "User activated successfully"
          schema:
            $ref: "#/definitions/UserHandle"
  /users/register:
    post:
      tags:
      - "user"
      summary: "Register user"
      description: "Create a new user"
      operationId: "registerUser"
      produces:
      - "application/json"
      parameters:
      - in: "body"
        name: "body"
        description: "User name and password"
        required: true
        schema:
          $ref: "#/definitions/UserRegistration"
      responses:
        201:
          description: "successful operation"
          schema:
            $ref: "#/definitions/UserHandle"
        400:
          description: "Invalid or existing username supplied"
  /users/whoami:
    get:
      tags:
      - "user"
      summary: "Get user information"
      description: "Get information about user that is associated with the provided access token"
      operationId: "whoami"
      produces:
      - "application/json"
      responses:
        200:
          description: "User Handle"
          schema:
            $ref: "#/definitions/UserHandle"
        403:
          description: "Forbidden operation"
      security:
        - api_key: []
# ------------------------------------------------------------------------------
# Security
# ------------------------------------------------------------------------------
securityDefinitions:
  api_key:
    type: apiKey
    name: api_key
    in: header
# ------------------------------------------------------------------------------
# Definition of data structures (models)
# ------------------------------------------------------------------------------
definitions:
  FileHandle:
    type: object
    description: "Handle for uploaded file"
    required:
    - id
    - name
    - createdAt
    - size
    - links
    properties:
      id:
        type: string
      name:
        type: string
      createdAt:
        type: string
      size:
        type: number
      links:
        $ref: "#/definitions/HATEOASLinks"
  FileListing:
    type: object
    description: "List of handles for uploaded files"
    required:
    - files
    - links
    properties:
      files:
        type: array
        items:
          $ref: "#/definitions/FileHandle"
      links:
        $ref: "#/definitions/HATEOASLinks"
  HATEOASLinks:
    type: array
    description: "List of HATEOAS references"
    items:
      $ref: "#/definitions/HATEOASRef"
  HATEOASRef:
    type: object
    description: "HATEOAS reference containing relationship type and HTTP reference"
    required:
    - rel
    - href
    properties:
      rel:
        type: string
        description: "Relationship type"
      href:
        type: string
        description: "HTTP link"
  RunArgument:
    type: object
    description: "Argument for a new workflow run"
    required:
    - id
    - value
    properties:
      id:
        type: string
      value:
        type: string
      as:
        type: string
  RunDescriptor:
    type: object
    description: "Descriptor containing basic information for workflow run"
    required:
    - id
    - state
    - createdAt
    - links
    properties:
      id:
        type: string
      state:
        type: string
      createdAt:
        type: string
      links:
        $ref: "#/definitions/HATEOASLinks"
  RunHandle:
    type: object
    description: "Handle containing all information for a workflow run"
    required:
    - id
    - arguments
    - state
    - links
    properties:
      id:
        type: string
      parameters:
        type: array
        items:
          $ref: '#/definitions/WorkflowParameter'
      arguments:
        type: array
        items:
          $ref: "#/definitions/RunArgument"
      state:
        type: string
      startedAt:
        type: string
      finishedAt:
        type: string
      messages:
        type: array
        items:
          type: string
      resources:
        type: array
        items:
          type: object
          required:
          - id
          - name
          - links
          properties:
            id:
              type: string
            name:
              type: string
            links:
              $ref: "#/definitions/HATEOASLinks"
      links:
        $ref: "#/definitions/HATEOASLinks"
  RunListing:
    type: object
    description: "Listing of run handles"
    required:
    - runs
    - links
    properties:
      runs:
        type: array
        items:
          $ref: "#/definitions/RunDescriptor"
      links:
        $ref: "#/definitions/HATEOASLinks"
  ServiceDescriptor:
    type: object
    description: "Descriptor containing basic service properties"
    required:
    - name
    - version
    - validToken
    - links
    properties:
      name:
        type: string
      version:
        type: string
      validToken:
        type: boolean
      username:
        type: string
      links:
        $ref: "#/definitions/HATEOASLinks"
  UserGroupHandle:
    type: object
    description: "Handle for workflow user group"
    required:
    - id
    - name
    - members
    - parameters
    - files
    - runs
    - links
    properties:
      id:
        type: string
      name:
        type: string
      members:
        type: array
        items:
          type: object
          required:
          - id
          - username
          properties:
            id:
              type: string
            name:
              type: string
      parameters:
        type: array
        items:
          $ref: '#/definitions/WorkflowParameter'
      files:
        type: array
        items:
          $ref: "#/definitions/FileHandle"
      runs:
        type: array
        items:
          $ref: "#/definitions/RunDescriptor"
      links:
        $ref: "#/definitions/HATEOASLinks"
  UserGroupListing:
    type: object
    description: 'List of user group descriptors'
    required:
    - groups
    - links
    properties:
      groups:
        type: array
        items:
          type: object
          required:
          - id
          - name
          - workflow
          - links
          properties:
            id:
              type: string
            name:
              type: string
            workflow:
              type: string
            links:
              $ref: "#/definitions/HATEOASLinks"
      links:
        $ref: "#/definitions/HATEOASLinks"
  UserCredentials:
    type: object
    description: "User login credentials"
    required:
    - username
    - password
    properties:
      username:
        type: string
      password:
        type: string
  UserDescriptor:
    type: object
    description: "Basic information about a registered user"
    required:
    - id
    - username
    properties:
      id:
        type: string
      username:
        type: string
  UserHandle:
    type: object
    description: "Information about a registered user"
    required:
    - id
    - username
    - links
    properties:
      id:
        type: string
      username:
        type: string
      token:
        type: string
      links:
        $ref: "#/definitions/HATEOASLinks"
  UserListing:
    type: object
    description: "Identifier and name of a registered users"
    required:
    - users
    - links
    properties:
      users:
        type: array
        items:
          $ref: "#/definitions/UserDescriptor"
      links:
        $ref: "#/definitions/HATEOASLinks"
  UserRegistration:
    type: object
    description: "Information about a new user"
    required:
    - username
    - password
    properties:
      username:
        type: string
      password:
        type: string
      verify:
        type: boolean
  WorkflowDescriptor:
    type: object
    required:
    - id
    - name
    - links
    properties:
      id:
        type: string
      name:
        type: string
      description:
        type: string
      instructions:
        type: string
      links:
        $ref: "#/definitions/HATEOASLinks"
  WorkflowHandle:
    type: object
    required:
    - id
    - name
    - links
    - parameters
    properties:
      id:
        type: string
      name:
        type: string
      description:
        type: string
      instructions:
        type: string
      parameters:
        type: array
        items:
          $ref: "#/definitions/WorkflowParameter"
      modules:
        type: array
        items:
          type: object
          required:
          - id
          - name
          - index
          properties:
            id:
              type: string
            name:
              type: string
            index:
              type: number
              format: int64
      postproc:
        $ref: "#/definitions/RunHandle"
      links:
        $ref: "#/definitions/HATEOASLinks"
  WorkflowLeaderboard:
    type: object
    description: "Ordered list of run results"
    required:
    - ranking
    - schema
    - links
    properties:
      ranking:
        type: array
        items:
          type: object
          required:
          - run
          - group
          - results
          properties:
            run:
              type: object
              required:
              - id
              - createdAt
              - startedAt
              - finishedAt
              properties:
                id:
                  type: string
                createdAt:
                  type: string
                startedAt:
                  type: string
                finishedAt:
                  type: string
            group:
              type: object
              required:
              - id
              - name
              properties:
                id:
                  type: string
                name:
                  type: string
            results:
              type: array
              items:
                type: object
                required:
                - id
                - value
                properties:
                  id:
                    type: string
                  value:
                    type: integer
      schema:
        type: array
        items:
          type: object
          required:
          - id
          - name
          - type
          properties:
            id:
              type: string
            name:
              type: string
            type:
              type: string
      resources:
        type: array
        items:
          type: object
          required:
            - id
            - name
          properties:
            id:
              type: string
            name:
              type: string
            caption:
              type: string
            links:
              $ref: "#/definitions/HATEOASLinks"
      links:
        $ref: "#/definitions/HATEOASLinks"
  WorkflowListing:
    type: object
    required:
    - workflows
    - links
    properties:
      workflows:
        type: array
        items:
          $ref: "#/definitions/WorkflowDescriptor"
      links:
        $ref: "#/definitions/HATEOASLinks"
  WorkflowParameter:
    type: object
    required:
    - id
    - name
    - datatype
    - index
    - required
    properties:
      id:
        type: string
      name:
        type: string
      datatype:
        type: string
      index:
        type: integer
      required:
        type: boolean
      description:
        type: string
      as:
        type: string
      defaultValue:
        type: string
      parent:
        type: string
      values:
        type: array
        items:
          type: object
          required:
          - value
          properties:
            name:
              type: string
            value:
              type: string
            isDefault:
              type: boolean
externalDocs:
  description: "Find out more about Swagger"
  url: "http://swagger.io"
